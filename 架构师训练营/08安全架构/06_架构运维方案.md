# 安全架构

## 架构运维方案

### 发布

网站需要保证7×24高可用运行，同时网站又需要不断的发布新功能吸引用户以保证在激烈的市场竞争中获得成功。许多大型网站每周都需要发布一到两次，而中小型网站则更加频繁，一些处于快速发展期的网站甚至每天发布十几次。

不管发布的新功能是修改了一个按钮的布局还是增加一个核心交易功能，都需要在服务器上关闭原有的应用，然后重新部署启动新的应用，整个过程还要求不影响用户的使用。这相当于是要求给飞行中的飞机换个引擎，既不能让飞机有剧烈的晃动，也不能让飞机降落，更不能让飞机坠毁。

既然网站的发布过程事实上和服务器宕机效果相当，那么就可以用服务器宕机的高可用方案来应对网站的发布。所以设计一个网站的高可用架构的时候，需要考虑的服务器宕机概率不是物理上的每年一两次，而是事实上的每周一两次。也许你认为这个应用不重要，重启也非常快，用户可以忍受每年一到两次的宕机故障，因而不需要复杂的高可用设计。事实上，由于应用的不断发布，用户需要面对的是每周一到两次的宕机故障。用户哭了。

### 自动化测试

代码在发布到线上服务器之前需要进行严格的测试。即使每次发布的新功能都是在原有系统功能上的小幅增加，但是为了保证系统没有引入未预料的BUG，网站测试还是需要对整个网站功能进行全面的回归测试。此外还需要测试各种浏览器的兼容性，在发布频繁的网站应用中，如果使用人工来进行，成本和时间都难以承受。

目前大部分网站都采用Web 自动化测试技术，使用自动测试工具或脚本完成测试。比较流行的Web 自动化测试工具是ThoughtWorks 开发的Selenium。Selenium 运行在浏览器中，模拟用户操作进行测试，因此Selenium 可以同时完成Web 功能测试和浏览器兼容测试。

知鱼君注：
单元测试是开发工程师自己的测试，单元模块内部没问题
测试工程师对整个系统进行测试
工程师应该对自己的代码质量进行负责
测试工程师不是为系统本身找bug，是要为线上系统负责，保证线上系统无bug
开发工程师保证自己开发的系统的准确性，测试工程师保证线上系统的正确性

雇个测试工程师，测试工程师在每次发布前进行应用测试。开始的时候， 这种成本是非常小的，但是增长却很快。每次开发新功能都需要对新功能进行测试，而前面已经发布的各种功能也需要进行测试，确保开发新功能不会破坏现有的产品功能。也就是说，每次发布的测试成本都比前一次发布的测试成本更高（测试效率随时间推移逐步降低）。这也会使软件的版本的发布周期逐渐变长，因为随着软件规模的增长，测试需要越来越长的时间。

自动化测试需要一些前置投资，你需要安装自动化测试工具，部署持续集成服务器， 但是后续投入却是相对便宜的。一旦完成初始安装，只需要为新功能创建测试就可以了， 测试已经存在的功能几乎不需要花费任何成本。随着时间的推移，测试会变得越来越高效， 每一次发布测试，已测试的代码和待测试的代码之比都在增加。最终，会到达一个平衡点， 然后自动化测试的总体成本会低于手工测试的成本。

### 自动化部署

持续集成
- 允许工程师随时向公共分支提交代码，并立即进行自动化测试。

持续交付
- 除了跑单元测试及软件打包，持续交付机制会将软件部署到各种测试环境中

持续部署
- 代码在没有人工干预的情况下被测试、构建、部署并推送到生产环境。

### 预发布验证

即使是经过严格的测试，软件部署到线上服务器之后还是经常会出现各种问题，甚至根本无法启动服务器。主要原因是测试环境和线上环境并不相同，特别是应用需要依赖的其他服务，如数据库，缓存、公用业务服务等，以及一些第三方服务，如电信短信网关、银行网银接口等。也许是接口变化导致的通信失败；也许是配置错误导致连接失败；也许依赖的服务在线上环境还没有准备好；这些问题都有可能导致应用故障。

因此在网站发布的时候，并不是把测试通过的代码包直接发布到线上服务器，而是先发布到预发布机器上，开发工程师和测试工程师在预发布服务器上进行预发布验证，执行一两个典型的业务流程，确认系统没有问题后才正式发布。

预发布服务器是一种特殊用途的服务器，它和线上的正式服务器唯一的不同就是没有配置在负载均衡服务器上，外部用户无法访问。

### 代码版本控制

对于大型互联网系统，核心应用系统和公用业务模块涉及许多团队和工程师，需要对相同的代码库进行共同开发和维护，而这些团队对同一个应用的开发维护，其开发周期和发布时间点各不相同。如何进行代码管理，既能保证代码发布版本的稳定正确，同时又能保证不同团队的开发互不影响。

主干开发、分支发布：
- 代码修改都在主干上进行，需要发布的时候，从主干上拉一个分支发布，该分支即成为一个发布版本，如果该版本发现Bug，继续在该分支上修改发布，并将修改合并（merge）回主干，直到下次主干发布。

分支开发，主干发布（优先）：
- 任何修改都不得在主干上直接进行，需要开发一个新功能或者修复一个bug 的时候，从主
干拉一个分支进行开发，开发完成测试通过后，合并回主干，然后从主干进行发布，主干上
的代码永远是最新发布的版本。

两种方式各有优缺点。主干开发、分支发布方式，主干代码反应目前整个应用的状态，一目了然，便于管理和控制，也利于持续集成。分支开发，主干发布方式，各个分支独立进行，互不干扰，可以使不同发布周期的开发在同一应用中进行。

目前互联网应用开发中主要使用的是分支开发、主干发布的方式

### 自动化发布

网站的版本发布频繁，整个发布过程需要许多团队合作，发布前，多个代码分支合并回主干可能会发生冲突（conflict），预发布验证也会带来风险，每次发布又相当于一次宕机事故。因此网站发布过程荆棘丛生，一不小心就会踩到雷。

### 灰度发布

应用发布完成功后，仍然可能会发现因为软件问题而引入的故障，这时候就需要做发布回滚，即卸载刚刚发布的软件，将上一个版本的软件包重新发布，使系统复原，消除故障。

大型网站的主要业务服务器集群规模非常庞大，比如QQ 的服务器数量超过一万台。一旦发现故障，即使想要发布回滚也需要很长时间才能完成，只能眼睁睁看着故障时间在不断增加干着急。为了应付这种局面，大型网站会使用灰度发布模式，将集群服务器分成若干部分，每天只发布一部分服务器，观察运行稳定没有故障，第二天继续发布一部分服务器，持续几天的时间才把整个集群全部发布完毕，期间如果发现问题，就只需要回滚已发布的一部分服务器即可。

### 网站运行监控

“不允许没有监控的系统上线”，这是许多网站架构师在做项目上线评审的时候常说的一句话。网站运行监控对于网站运维和架构设计优化至关重要，没有监控的网站，犹如盲人骑瞎马，夜半临深渊而不知。生死未卜，提高可用性、减少故障率就更无从做起了。

### 监控数据采集

广义上的网站监控涵盖所有非直接业务行为的数据采集与管理，包括供数据分析师和产品设计师使用的网站用户行为日志，业务运行数据和系统性能数据等。

### 用户行为日志收集

用户行为日志指用户在浏览器上所做所有操作及其所在的操作环境，包括用户操作系统与浏览器版本信息，IP 地址，页面访问路径，页面停留时间等，这些数据对统计网站PV/UV 指标，分析用户行为，优化网站设计，个性化营销与推荐等非常重要。

具体用户行为日志收集手段有两种

服务器端日志收集，这个方案比较简单，Apache 等几乎所有Web 服务器都具备日志记录功能，可以记录大部分用户行为日志，开启Web 服务器的日志记录功能即可。其缺点是可能会出现信息失真，如IP 地址是代理服务器地址而不是用户真实IP；多个链接指向同一个页面的情况下无法分辨访问路径等。

客户端浏览器日志收集，浏览器可以收集用户真实的操作行为，因此比服务器日志收集更加精准。其缺点是比较麻烦，需要在页面嵌入特定的JS 脚本来完成。

### 服务器性能监控

收集服务器性能指标，如系统Load，内存占用，磁盘IO，网络IO 等对尽早做出故障预警，及时判断应用状况，防患于未然，将故障扼杀在萌芽时期非常重要。此外根据性能监控数据，运维工程师可以合理安排服务器集群规模，架构师及时改善系统性能及调整系统伸缩性策略

目前网站使用比较广泛的开源性能监控工具是Ganglia，支持大规模服务器集群，并支持以图形的方式在浏览器展示实时性能曲线。

### 业务运行数据报告

除了服务器系统性能监控，网站还需要监控一些具体业务场景相关的技术和业务指标，比如缓冲命中率、平均响应延迟时间、每分钟发送邮件数目、待处理的任务总数等。不同同于服务器性能监控，网站运维人员可以在初始化系统的时候统一部署，业务运行数据需要在具体程序中采集并报告，汇总后统一显示。

### 监控管理

监控数据采集后，除了用作系统性能评估、集群规模伸缩性预测等，还可以根据实时监控数据进行风险预警，并对服务器进行失效转移，自动负载调整，最大化利用集群所有机器的资源。

报警
服务器运行正常的情况下，其各项监控指标基本稳定在一个特定水平，如果这些指标超过某个阀值，就意味着系统可能将要出现故障，这时候就需要对相关人员报警，及时采取措施，在故障还未真正发生就将其扼杀在萌芽状态。

监控管理系统可以配置报警阀值和值守人员的联系方式，报警方式除了邮件，即时通讯工具，还可以配置手机短信，语音报警，保证发生报警时，工程师即使在千里之外、夜里睡觉也能及时通知，迅速响应。

自动控制
自动失效转移：除了应用程序访问失败时进行失效转移，监控系统也可以在发现故障的情况下主动通知应用，进行失效转移。
自动扩容：如果因访问压力大而导致服务性能指标下降，监控系统自动触发服务集群扩容。
自动限流：根据监控指标，自动控制访问流量。

### 高可用的价值观

保持简单，使问题易于发现，快速解决。
目标明确，解决特定环境下的具体问题。
价值回归，成本收益要合理。

