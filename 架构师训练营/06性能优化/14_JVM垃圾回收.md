# 性能优化

## JVM垃圾回收

JVM 垃圾回收就是将JVM 堆中的已经不再被使用的对象清理掉，释放宝贵的内存资源。

JVM 通过一种可达性分析算法进行垃圾对象的识别，具体过程是：从线程栈帧中的局部变量，或者是方法区的静态变量出发，将这些变量引用的对象进行标记，然后看这些被标记的对象是否引用了其他对象，继续进行标记，所有被标记过的对象都是被使用的对象，而那些没有被标记的对象就是可回收的垃圾对象了。

进行完标记以后，JVM 就会对垃圾对象占用的内存进行回收，回收主要有三种方法

- 清理：将垃圾对象占据的内存清理掉，其实JVM 并不会真的将这些垃圾内存进行清理，而是将这些垃圾对象占用的内存空间标记为空闲，记录在一个空闲列表里，当应用程序需要创建新对象的时候，就从空闲列表中找一段空闲内存分配给这个新对象。
- 压缩：从堆空间的头部开始，将存活的对象拷贝放在一段连续的内存空间中，那么其余的空间就是连续的空闲空间。
- 复制：将堆空间分成两部分，只在其中一部分创建对象，当这个部分空间用完的时候，将标记过的可用对象复制到另一个空间中。

### JAVA启动参数

标准参数，所有的JVM 实现都必须实现这些参数的功能，而且向后兼容
- 运行模式-server,-client
- 类加载路径-cp,-classpath
- 运行调试–verbose
- 系统变量–D

非标准参数， 默认jvm实现这些参数，但不保证所有JVM 实现都实现，且不保证向后兼容
- -Xms 初始堆大小
- -Xmx 最大堆大小
- -Xmn 新生代大小
- -Xss 线程堆栈大小
非Stable参数， 此类参数各个jvm实现会有所不同，将来可能会随时取消
- -XX:-UseConcMarkSweepGC 启用CMS 垃圾回收

### JVM 性能诊断工具

基本工具：JPS ，JSTAT，JMAP，JSTACK
集成工具: JConsole，JVisualVM

#### JPS

JPS 用来查看host 上运行的所有Java 进程的pid（jvmid），一般情况下使用这个工具的目的只是为了找出运行的JVM 进程ID，即lvmid，然后可以进一步使用其它的工具来监控和分析JVM

常用的几个参数：
- -l 输出Java 应用程序的main class 的完整包
- -q 仅显示pid，不显示其它任何相关信息
- -m 输出传递给main 方法的参数
- -v 输出传递给JVM 的参数。在诊断JVM 相关问题的时候，这个参数可以查看JVM 相关参数的设置

#### JSTAT

JSTAT（ “Java Virtual Machine statistics monitoring tool” ）是JDK 自带的一个轻量级
小工具。主要对Java 应用程序的资源和性能进行实时的命令行的监控，包括了对Heap
size 和垃圾回收状况的监控。
语法结构如下：jstat [Options] vmid [interval] [count]
- Options -- 选项，我们一般使用- gcutil 查看gc 情况
- vmid -- VM 的进程号，即当前运行的Java 进程号
- interval-- 间隔时间，单位为毫秒
- count -- 打印次数，如果缺省则打印无数次

#### JMAP

JMAP 是一个可以输出所有内存中对象的工具，甚至可以将VM 中的heap，以二进制输出成文本。
使用方法
- jmap -histo pid>a.log 可以将其保存到文本中去，在一段时间后，使用文本对比工具，可以对比出GC 回收了哪些对象。
- jmap -dump:format=b,file=f1 PID 可以将该PID 进程的内存heap 输出出来到f1文件里。

#### jstack

jstack 可以查看JVM 内的线程堆栈信息