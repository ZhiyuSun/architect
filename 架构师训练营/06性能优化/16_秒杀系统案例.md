# 性能优化

## 秒杀系统案例

### 背景

XXXX 网站的正常流量情况
- 并发（单台），高峰期< 10；
- 吞吐量（TPS，单台） 高峰期，<60；
- CPU负载Load 高峰期，<2，大部分服务器<1；
- CPU使用率， 一般只占1 颗核，平均60% 左右；
- 服务器平均响应时间高峰期， <150ms；
- 图片总流量带宽1.8G（各网站总合）。

高并发下的风险
- 网络带宽耗尽
- 服务器Load 飙高，停止响应。
- 数据库瘫痪

高并发下的事故
- 事故：网站运营推广页面弹出1兆大图片导致带宽耗尽
- 增加审核机制：运营推广增加的图片流量不能超过现有流量的30%
- 合作媒体推广：迅雷，暴风影音浮出广告，导致ZZ 集群Crash。

秒杀
- XXXX.com 开业88 小时不间断秒杀活动

商业需求
- 为庆祝XXXX.com 开业退出88 小时不间断秒杀活动。
- 每小时整点推出8 款商品……
- 每款商品供168 件，每人限批3 件，成交人数56 人。
- CCTV 黄金广告时间，各种网络，平面媒体轰炸，总广告费：1.5 亿。
- 接到运营通知，距秒杀开始仅仅5 天时间。

技术挑战
- 瞬间高并发
    - 8000 并发：预估秒杀在线人数可达8000 人。
    - 风险：带宽耗尽。
    - 服务器：崩溃，可以理解成自己给自己准备的D.D.O.S 攻击。
- 秒杀器
    - 第一种：秒杀前不断刷新秒杀页面，直到秒杀开始，抢着下单。
    - 第二种：跳过秒杀页面，直接进入下单页面，下单。

如何出人头地，机会一定会出现在巨大的挑战和危机当中，你能干出来，机会就到了，提前做好能力上、技术上、心理素质上的准备

### 如何做

服务器准备（距秒杀开始仅五天时间来不及采购）
- style 服务器（Lighttpd集群）：5台
- 图片服务器（Nginx集群） ：5台
- 静态服务器（Apache集群） ：10台
- 交易服务器（JBoss动态集群）：10台

带宽准备
- 图片出口带宽上限：2.5G （出口带宽支持10G，但图片服务器集群的处理能力：图片服务集群最大并发处理能力X 网站平均图片大小= 2.5G）
- CDN 准备：Chinacache 沟通；借用CCCC CDN

#### 架构目标

1.图片网络带宽：1.0G
新增图片带宽：必须控制在1.0G 左右
每件商品秒杀页面的图片总大小不得超过：1000000/(1000*8) = 125K/每商品

2.网站并发：
单件商品并发：1000 【来自运营的预估】
总并发: 8（件商品）X 1000（人/商品）= 8000

#### 组成

简单系统：
三个页面组成：秒杀商品列表，秒杀商品介绍，下单
下单成功后，进入支付系统，走支付流程

#### 设计原则

静态化
- 采用JS 自动更新技术将动态页面转化为静态页面

并发控制，防秒杀器
- 设置阀门，只放最前面的一部分人进入秒杀系统

简化流程
- 砍掉不重要的分支流程，如下单页面的所有数据库查询
- 以下单成功作为秒杀成功标志。支付流程只要在1 天内完成即可。

前端优化
- 采用YSLOW 原则提升页面响应速度

#### 静态化

秒杀商品list 和Detail 是静态HTML 页面
秒杀商品列表/秒杀商品介绍页面，如何判断秒杀开始否。

#### 三道阀门的设计

#### 秒杀器的预防

秒杀Detail 页面
- URL：随机
- 秒杀前2秒放出，脚本生成，秒杀前。
- 1000次访问上限控制【每件商品只能放入1000人浏览】

下单页面：
- 订单ID，随机。
- 不能直接跳过秒杀Detail 页面进入。
- 每个秒杀商品，带预先生成的随机Token 作URL 参数。
- 如果秒杀过，直接跳到秒杀结束页面。
- 100 次访问上限控制【每件商品只能放入1000人下单】。

#### Apache调优

- KeepAlive 相关参数调优
- 其他参数调优
    - HostnameLookups 设为off， 对allowfromdomain 等后的域名不进行正向和反向的dns 解析。
- 关闭cookies-log 日志
- 打开Linux sendfile()
- 关闭无用的module
    - mod_Gzip
    - （秒杀页面，非图片HTML 文本所占流量比重可忽略不计，zip 意义不大）
    - mod_Beacon
    - mod_hummock（等待反应过来，秒杀已经over 了）

#### JBOSS调优

#### 秒杀静态页面优化

图片合并
- 8 张图片合并成1 张，CSS 偏移展示。
- 减少HTTP 请求数，减少请求等待数。
- 减少发送Cookies 的量。

HTML 内容压缩
图片压缩：图片Bytes < 长X宽/2250
HTML Header Cache-Control 设置
CSS，JS 精简
- CSS，JS 精简到极致，部分直接写在页面中，减少HTTP 请求次数。

#### 下单页面优化

数据库操作：全部砍掉
- 原下单页面要访问8 次数据库，全部砍掉。

秒杀流程精简
- 砍掉填写或选择收货地址，放在秒杀成功后填写。
- 砍掉调用是否开通支付接口，秒杀首页文案提示必须开通。

采用内存缓存
- 秒杀Offer 数据，支付相关信息，缓存。

#### 交易系统性能优化

交易系统调优目标：
- 关闭KeepAlive（分析交易系统accesslog，用户在短时间内连续点击概率很低）
- JVM 优化
- 优化CMS 垃圾回收器的参数
- 消灭Top10 Bottlenecks
    - Velocity 参数调优
    - 采用DBCP1.4 替换C3P0
    - Offer 产品参数的XML 解析

#### 二级页面的优化

XXXX.com 其他页面
- 前端优化： Yslow 规则调优
    - 减少HTTP 请求，合并JS，CSS，图片，充分利用浏览器缓存。
- 图片压缩，公式：
- 避免发送Cookies

交易系统优化
- 普通订单管理列表和XXXX 秒批订单管理列表分离
- 禁止用模糊查询功能

#### 应急预案

- 域名分离，独立域名，不影响XXXX原有业务。
    - Style 集群： style.XXXX.china.XXXX.com
    - 图片服务器集群：img.XXXX.china.XXXX.com
    - 静态页面集群：page.XXXX.china.XXXX.com
    - 出问题直接把XXXX 相关域名卡掉，所有请求跳到万能出错页面。
- 机动服务器10台，备用。
- 拆东墙补西墙战略
    - 5天时间来不及采购服务器，因此SA 待命，随时准备将非核心应用集群的冗余服务器下线，加入到秒杀集群。
- 壁虎断尾策略
    - 所有办法均失效的情况下，例如流量耗尽。
        - 非核心应用集群统统停止服务，如资讯，论坛，博客等社区系统。
        - 保住首页，Offer Detail，旺铺页面等核心应用的可用性。
- 万能出错页面：秒杀活动已经结束
    - 任何出错都302 跳转到此页面
    - 位于另外集群
- 万幸：最终所有的预案都没有用上

#### 结果

88 小时秒杀，坚守阵地，大获成功。
秒杀还是被秒杀？终于有了答案
三道阀门设计非常有效，拦住了秒杀器。