# 性能优化

## 性能优化

### 软件性能优化的两个基本原则

- 你不能优化一个没有测试的软件
- 你不能优化一个你不了解的软件

### 性能测试的主要指标

- 响应时间：完成一次任务花费的时间
- 并发数：同时处理的任务数
- 吞吐量：单位时间完成的任务数
- 性能计数器：System Load，线程数，进程数，CPU、内存、磁盘、网络使用率

### 性能优化的一般方法

- 性能测试，获得性能指标
- 指标分析，发现性能与资源瓶颈点
- 架构与代码分析，寻找性能与资源瓶颈关键所在
- 架构与代码优化，优化关键技术点，平衡资源利用
- 性能测试，进入性能优化闭环

### 系统性能优化的分层思想

- 机房与骨干网络性能优化
- 服务器与硬件性能优化
- 操作系统性能优化
- 虚拟机性能优化
- 基础组件性能优化
- 软件架构性能优化
- 软件代码性能优化

#### 机房与骨干网络性能优化

异地多活的多机房架构
专线网络与自主CDN 建设

##### 服务器与硬件性能优化

使用更优的CPU，磁盘，内存，网卡，对软件的性能优化可能是数量级的，有时候远远超过代码和架构的性能优化。

Spark 作业过程需要传输大量数据，进行资源瓶颈分析，发现大量时间消耗在网络传输上。

优化方案：升级网卡，10G 网卡代替1G 网卡

#### 操作系统性能优化案例

资源利用分析，发现大量CPU操作为sys 类型，消耗大量计算资源。

调查发现，起因是部分Linux版本缺省情况打开tranparent huge page 导致。
优化方案：关闭transparent huge page

#### 虚拟机型优化
#### 基础组件性能优化

### 软件架构性能优化三板斧

- 缓存
- 异步
- 集群

#### 缓存

从内存获取数据，减少响应时间
减少数据库访问，降低存储设备负载压力
缓存结果对象，而不是原始数据，减少CPU 计算
缓存主要优化读操作

#### 异步

即时响应，更好的用户体验
控制消费速度，合适的负载压力
异步主要优化写操作

#### 集群

古老谚语：如果一匹马拉不动车，无需换一匹更强的马，而是用两匹马拉车。

互联网技术的发展路径就是：更多的用户访问需要消耗更多的计算资源，单一服务器计算资源的增加是有极限的，所以需要增加更多的服务器。关键是如何利用起来这些服务器。

集群的技术目标只有一个：如何使很多台服务器对使用者而言看起像一台服务器。

### 软件代码性能优化

遵循面向对象的设计原则与设计模式编程，很多时候程序性能不好不是因为性能上有什么技术挑战，仅仅就是因为代码太烂了。

并发编程，多线程与锁
资源复用，线程池与对象池
异步编程，生产者消费者
数据结构，数组、链表、hash 表、树

#### 代码优化案例

Spark 任务文件初始化调优

- 资源分析，发现第一个stage 时间特别长，耗时长达14s，CPU 和网络通信都有一定开销，不符合应用代码逻辑。

打开Spark 作业log，分析这段时间的Spark 运行状况。
根据log 分析结果，阅读Spark 相关源码。
发现Spark 在任务初始化加载应用代码的时候，每个Executor 都加载一次应用代码，
当时每台服务器最多可启动48个Executor，每个应用代码包17M大小，导致加载开销巨大。
优化方案：Executor 加载应用程序包启用本地文件缓存模式。[SPARK-2713]
优化效果：Stage1运行时间从14s下降到不到1s。
